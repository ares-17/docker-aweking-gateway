<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Awakening {{ .ContainerName }}</title>
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&amp;family=Space+Grotesk:wght@300;400;500;600;700&amp;display=swap"
    rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            "bg-dark": "#0d1117",
            "surface-dark": "#161b22",
            "text-main": "#c9d1d9",
            "text-muted": "#8b949e",
            "docker-blue": "#2496ed",
            "border-dark": "#30363d",
            "error-red": "#f85149",
            "error-surface": "#1a0d0d",
          },
          fontFamily: {
            "display": ["Space Grotesk", "sans-serif"],
            "mono": ["JetBrains Mono", "monospace"],
          },
          backgroundImage: {
            'technical-grid': "linear-gradient(to right, rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.05) 1px, transparent 1px)",
            'striped-bar': "linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent)",
          },
          animation: {
            'breathe': 'breathe 2s ease-in-out infinite',
            'barber-pole': 'barberpole 1s linear infinite',
            'shake': 'shake 0.4s ease-in-out',
          },
          keyframes: {
            breathe: { '0%, 100%': { transform: 'scale(0.95)' }, '50%': { transform: 'scale(1.05)' } },
            barberpole: { '0%': { backgroundPosition: '40px 0' }, '100%': { backgroundPosition: '0 0' } },
            shake: { '0%,100%': { transform: 'translateX(0)' }, '25%': { transform: 'translateX(-4px)' }, '75%': { transform: 'translateX(4px)' } },
          }
        },
      },
    }
  </script>
  <style>
    .bg-grid-pattern {
      background-size: 20px 20px;
    }

    .blink-1 {
      animation: blink 1.0s infinite;
      animation-delay: 0.1s;
    }

    .blink-2 {
      animation: blink 1.2s infinite;
      animation-delay: 0.3s;
    }

    .blink-3 {
      animation: blink 0.8s infinite;
      animation-delay: 0.5s;
    }

    .blink-4 {
      animation: blink 1.5s infinite;
      animation-delay: 0.2s;
    }

    .blink-5 {
      animation: blink 1.1s infinite;
      animation-delay: 0.7s;
    }

    .blink-6 {
      animation: blink 0.9s infinite;
      animation-delay: 0.4s;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 0.2;
      }

      50% {
        opacity: 1;
      }
    }

    #log-box::-webkit-scrollbar {
      width: 4px;
    }

    #log-box::-webkit-scrollbar-track {
      background: transparent;
    }

    #log-box::-webkit-scrollbar-thumb {
      background: #30363d;
      border-radius: 2px;
    }
  </style>
</head>

<body
  class="bg-bg-dark text-text-main font-display min-h-screen flex flex-col overflow-hidden relative selection:bg-docker-blue selection:text-white antialiased">
  <div class="absolute inset-0 bg-technical-grid bg-grid-pattern z-0 pointer-events-none"></div>

  <div class="relative z-10 flex flex-col items-center justify-center flex-grow w-full h-full p-4 sm:p-6">
    <div id="card"
      class="w-full max-w-[600px] bg-surface-dark border border-border-dark rounded shadow-lg overflow-hidden">

      {{/* ── Header ─────────────────────────────────────────────── */}}
      <div class="px-6 py-5 border-b border-border-dark flex items-center justify-between">
        <div id="status-badge"
          class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-bg-dark border border-border-dark">
          <span class="relative flex h-2 w-2">
            <span id="ping-outer"
              class="animate-ping absolute inline-flex h-full w-full rounded-full bg-docker-blue opacity-75"></span>
            <span id="ping-inner" class="relative inline-flex rounded-full h-2 w-2 bg-docker-blue"></span>
          </span>
          <span id="status-text" class="font-mono text-xs font-medium tracking-wide text-text-main">STATUS:
            AWAKENING</span>
        </div>
        <div class="hidden sm:flex gap-1.5 opacity-20">
          <div class="w-2.5 h-2.5 rounded-full bg-text-main"></div>
          <div class="w-2.5 h-2.5 rounded-full bg-text-main"></div>
          <div class="w-2.5 h-2.5 rounded-full bg-text-main"></div>
        </div>
      </div>

      {{/* ── Main area ───────────────────────────────────────────── */}}
      <div class="p-8 sm:p-10 flex flex-col items-center text-center">

        {{/* Container icon */}}
        <div class="mb-8 relative">
          <div id="container-icon"
            class="w-16 h-16 border-2 border-text-main animate-breathe flex flex-wrap content-center justify-center gap-1 p-1 bg-surface-dark relative z-10">
            <div class="w-1 h-1 bg-docker-blue blink-1 rounded-[1px]"></div>
            <div class="w-1 h-1 bg-docker-blue blink-2 rounded-[1px]"></div>
            <div class="w-1 h-1 bg-docker-blue blink-3 rounded-[1px]"></div>
            <div class="w-1 h-1 bg-docker-blue blink-4 rounded-[1px]"></div>
            <div class="w-1 h-1 bg-docker-blue blink-5 rounded-[1px]"></div>
            <div class="w-1 h-1 bg-docker-blue blink-6 rounded-[1px]"></div>
          </div>
          <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[1px] h-[160%] bg-border-dark -z-0">
          </div>
          <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[160%] h-[1px] bg-border-dark -z-0">
          </div>
        </div>

        <h1 class="text-xl sm:text-2xl font-semibold leading-tight mb-2 text-text-main tracking-tight">
          Container <span class="font-mono text-docker-blue text-lg sm:text-xl">[{{ .ContainerName }}]</span> spin-up
          initialized
        </h1>
        <p id="subtitle" class="font-mono text-xs sm:text-sm text-text-muted mb-6">
          Allocating resources&hellip; Do not reload. &nbsp;&bull;&nbsp; timeout: <span class="text-text-main">{{
            .StartTimeout }}</span>
        </p>

        {{/* Progress bar — hidden when error state is shown */}}
        <div id="progress-area" class="w-full mb-6">
          <div class="w-full h-1 bg-border-dark rounded-none overflow-hidden relative">
            <div
              class="h-full bg-docker-blue bg-striped-bar bg-[length:40px_40px] animate-barber-pole absolute top-0 left-0 rounded-r-sm"
              style="width:100%;"></div>
          </div>
        </div>

        {{/* Inline error box — hidden by default */}}
        <div id="error-area" class="hidden w-full mb-6">
          <div class="w-full bg-error-surface border border-error-red/40 rounded-sm p-4 text-left">
            <div class="flex items-center gap-2 mb-2">
              <svg class="w-4 h-4 text-error-red flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
              </svg>
              <span class="font-mono text-xs font-bold text-error-red uppercase tracking-wider">Start Failed</span>
            </div>
            <p id="error-msg" class="font-mono text-xs text-error-red/80 break-all"></p>
            <button onclick="window.location.reload()"
              class="mt-3 px-4 py-1.5 border border-error-red/40 text-error-red/80 font-mono text-xs hover:bg-error-red/10 transition-colors rounded-sm">
              ↺ Retry
            </button>
          </div>
        </div>

        {{/* Log box */}}
        <div class="w-full">
          <div class="flex items-center gap-2 mb-2">
            <span class="font-mono text-[10px] text-text-muted uppercase tracking-widest">container output</span>
            <div id="log-status" class="w-1.5 h-1.5 rounded-full bg-text-muted opacity-50"></div>
          </div>
          <div id="log-box"
            class="w-full h-36 bg-bg-dark border border-border-dark rounded-sm overflow-y-auto font-mono text-[11px] leading-relaxed text-left p-3 text-text-muted">
            <span class="opacity-40 italic">Waiting for container output&hellip;</span>
          </div>
        </div>

      </div>
    </div>
  </div>

  {{/* Footer */}}
  <div class="fixed bottom-0 left-0 w-full py-4 px-6 text-center sm:text-left bg-transparent z-20 pointer-events-none">
    <p class="font-mono text-[10px] text-text-muted opacity-50 uppercase tracking-wider">
      instance-id: {{ .RequestID }} <span class="mx-2 text-border-dark">|</span> req-path: {{ .RequestPath }}
    </p>
  </div>

  <script>
      (function () {
        const CONTAINER = {{ printf "%q" .ContainerName }
      };
    const REDIRECT = {{ printf "%q" .RedirectPath }};

    function qs() {
      const u = new URL(window.location.href);
      u.searchParams.set('container', CONTAINER);
      return u.searchParams.toString();
    }

    // ── DOM refs ──────────────────────────────────────────────────────────────
    const logBox = document.getElementById('log-box');
    const logStatus = document.getElementById('log-status');
    const progressArea = document.getElementById('progress-area');
    const errorArea = document.getElementById('error-area');
    const errorMsg = document.getElementById('error-msg');
    const statusText = document.getElementById('status-text');
    const pingOuter = document.getElementById('ping-outer');
    const pingInner = document.getElementById('ping-inner');
    const subtitle = document.getElementById('subtitle');
    const icon = document.getElementById('container-icon');

    let firstLog = true;
    let stopped = false;

    // ── Show inline error state ───────────────────────────────────────────────
    function showError(msg) {
      if (stopped) return;
      stopped = true;

      // Update header badge
      statusText.textContent = 'STATUS: FAILED';
      pingOuter.classList.replace('bg-docker-blue', 'bg-error-red');
      pingInner.classList.replace('bg-docker-blue', 'bg-error-red');
      pingOuter.classList.remove('animate-ping');

      // Update icon
      icon.classList.remove('animate-breathe');
      icon.classList.add('border-error-red/50', 'animate-shake');

      // Swap progress ↔ error box
      progressArea.classList.add('hidden');
      errorArea.classList.remove('hidden');
      errorMsg.textContent = msg;

      subtitle.textContent = 'Container failed to start.';
    }

    // ── Log polling ───────────────────────────────────────────────────────────
    async function fetchLogs() {
      if (stopped) return;
      try {
        const r = await fetch('/_logs?' + qs());
        if (!r.ok) return;
        const data = await r.json();
        const lines = data.lines || [];
        if (!lines.length) return;
        if (firstLog) { logBox.innerHTML = ''; firstLog = false; }
        logBox.innerHTML = '';
        for (const line of lines) {
          const el = document.createElement('div');
          el.textContent = line;
          logBox.appendChild(el);
        }
        logBox.scrollTop = logBox.scrollHeight;
        logStatus.classList.replace('bg-text-muted', 'bg-docker-blue');
        logStatus.classList.remove('opacity-50');
      } catch (_) { }
    }

    // ── Health polling ────────────────────────────────────────────────────────
    async function checkHealth() {
      if (stopped) return;
      try {
        const r = await fetch('/_health?' + qs());
        if (!r.ok) return;
        const data = await r.json();
        if (data.status === 'running') {
          stopped = true;
          window.location.replace(REDIRECT);
        } else if (data.status === 'failed') {
          showError(data.error || 'Unknown error');
        }
      } catch (_) { }
    }

    // Start polling
    fetchLogs();
    setInterval(fetchLogs, 3000);
    checkHealth();
    setInterval(checkHealth, 2000);
}) ();
  </script>
</body>

</html>