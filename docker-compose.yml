services:
  # ============================================================
  # Docker Awakening Gateway
  # ============================================================
  gateway:
    build: .
    container_name: docker-gateway
    ports:
      - "8080:8080"
    volumes:
      # Docker socket — read-only; the gateway only needs inspect + start/stop
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Mount the config file
      - ./config.yaml:/etc/gateway/config.yaml:ro
    environment:
      - CONFIG_PATH=/etc/gateway/config.yaml
    restart: unless-stopped

  # ============================================================
  # TEST — slow-app
  # Simulates a container with a long boot time (~15s).
  # Tests: normal awakening flow, log box content, redirect
  # ============================================================
  slow-app:
    image: nginx:alpine
    container_name: slow-app
    labels:
      - "dag.enabled=true"
      - "dag.host=slow-app.localhost:8080"
      - "dag.icon=nginx"
      - "dag.target_port=80"
      - "dag.start_timeout=120s"
      - "dag.idle_timeout=5m"
      - "dag.redirect_path=/"
    # Override entrypoint to add boot delay before nginx starts
    entrypoint: ["/bin/sh", "-c", "echo 'slow-app: boot sequence started'; sleep 15; echo 'slow-app: boot complete, starting nginx'; nginx -g 'daemon off;'"]
    # NOTE: do NOT add 'restart' — we want the container startable by the gateway

  # ============================================================
  # TEST — fail-app
  # Always exits immediately with an error.
  # Tests: start_timeout expiry → error page
  # ============================================================
  fail-app:
    image: alpine
    container_name: fail-app
    entrypoint: ["/bin/sh", "-c", "echo 'fail-app: simulating crash'; exit 1"]
